# 《MySQL 实战 45 讲》笔记

[MySQL 实战 45 讲](https://time.geekbang.org/column/intro/100020801)

当在代码里写下一行数据库命令的时候，我就能想到它在数据库端将怎么执行，它的性能是怎么样的，怎样写能让我的应用程序访问数据库的性能最高。进一步，哪些数据处理让数据库系统来做性能会更好，哪些数据处理在缓存里做性能会更好，我心里也会更清楚。在建表和建索引的时候，我也会更有意识地为将来的查询优化做综合考虑，比如确定是否使用递增主键、主键的列怎样选择，等等。

数据库系统也是一个应用系统。

原理先行，再实践验证。

## 基础架构:一条SQL查询语句是如何执行的?

>  看一个事儿千万不要直接陷入细节里，应该先鸟瞰其全貌，这样能够从高维度理解问题。

![](/Users/andyron/myfield/github/LearnDatabase/beta/MySQL-45/images/image-20211126154201758.png)

Server层和存储引擎。

### 连接器

连接器负责跟客户端建立连 接、获取权限、维持和管理连接。连接命令一般：

```mysql
mysql -h$ip -P$port -u$user -p
```

如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面 的权限判断逻辑，都将依赖于此时读到的权限。

一个用户成功建立连接后，管理员修改这个用户权限，也不会影响已经存在连接的权限，只有下次连接修改的权限才会生效。

`show processlist`命令可查看连接情况。

```mysql
mysql> show processlist;
+----+-----------------+-----------------+------+---------+--------+------------------------+------------------+
| Id | User            | Host            | db   | Command | Time   | State                  | Info             |
+----+-----------------+-----------------+------+---------+--------+------------------------+------------------+
|  5 | event_scheduler | localhost       | NULL | Daemon  | 514524 | Waiting on empty queue | NULL             |
| 17 | root            | localhost:64006 | db01 | Sleep   |     25 |                        | NULL             |
| 18 | root            | localhost       | NULL | Query   |      0 | init                   | show processlist |
+----+-----------------+-----------------+------+---------+--------+------------------------+------------------+
3 rows in set (0.00 sec)
```

客户端如果太长时间没动静（默认8小时，由参数`wait_timeout`控制），连接就会自动断开，Command列显示为Sleep，

```mysql
mysql> show variables like "wait_timeout";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| wait_timeout  | 28800 |
+---------------+-------+
```

数据库里，**长连接**指连接成功后，一直请求一直使用同一个连接；**短连接**指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。

建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，也就是尽量使用**长连接**。

但因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的，长连接累积下来，内存占用过大，会被系统强行杀掉(OOM)，从现 象看就是MySQL异常重启了。

解决方案：

1. 定期断开长连接。
2. MySQL>=5.7，可以在执行比较大的操作后，执行`mysql_reset_connection()`来重新初始化连接资源，这个过程不需要重连和重新做权限验证， 但是会将连接恢复到刚刚创建完时的状态。



### 查询缓存





